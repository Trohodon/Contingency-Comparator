import os
import tkinter as tk
from tkinter import ttk, filedialog, messagebox

from PIL import Image

SIZES = [16, 32, 48, 64, 128, 256]


def _center_crop_to_square(img: Image.Image) -> Image.Image:
    w, h = img.size
    side = min(w, h)
    left = (w - side) // 2
    top = (h - side) // 2
    return img.crop((left, top, left + side, top + side))


def _pad_to_square(img: Image.Image, bg=(0, 0, 0, 0)) -> Image.Image:
    w, h = img.size
    side = max(w, h)
    out = Image.new("RGBA", (side, side), bg)
    out.paste(img, ((side - w) // 2, (side - h) // 2))
    return out


def _prepare_base(img: Image.Image, mode: str) -> Image.Image:
    if img.mode != "RGBA":
        img = img.convert("RGBA")

    if mode == "crop":
        base = _center_crop_to_square(img)
    elif mode == "pad":
        base = _pad_to_square(img)
    elif mode == "stretch":
        # make it square first (distorts if not square)
        side = max(img.size)
        base = img.resize((side, side), Image.LANCZOS)
    else:
        raise ValueError("mode must be crop/pad/stretch")
    return base


def export_multi_ico(base_img: Image.Image, ico_path: str):
    """One ICO file containing all sizes."""
    base_img.save(ico_path, format="ICO", sizes=[(s, s) for s in SIZES])


def export_split_icos(base_img: Image.Image, out_dir: str, base_name: str):
    """
    Writes one .ico per size:
      base_name_16.ico, base_name_32.ico, ...
    """
    os.makedirs(out_dir, exist_ok=True)

    for s in SIZES:
        out_path = os.path.join(out_dir, f"{base_name}_{s}.ico")
        im = base_img.resize((s, s), Image.LANCZOS)
        # Save a single-size ICO
        im.save(out_path, format="ICO", sizes=[(s, s)])


class IconMakerApp(ttk.Frame):
    def __init__(self, master):
        super().__init__(master)
        self.master = master

        self.png_path = tk.StringVar(value="")
        self.out_dir = tk.StringVar(value="")
        self.base_name = tk.StringVar(value="app")
        self.mode_var = tk.StringVar(value="pad")

        self.make_combined_var = tk.BooleanVar(value=True)
        self.make_split_var = tk.BooleanVar(value=True)

        self._build_ui()

    def _build_ui(self):
        self.master.title("PNG → ICO Exporter (Combined + Split Sizes)")
        self.master.minsize(760, 330)

        try:
            style = ttk.Style()
            style.theme_use("vista")
        except Exception:
            pass

        wrap = ttk.Frame(self.master, padding=(14, 14))
        wrap.pack(fill=tk.BOTH, expand=True)

        ttk.Label(wrap, text="PNG → Windows Icons", font=("Segoe UI", 14, "bold")).grid(
            row=0, column=0, columnspan=3, sticky="w", pady=(0, 6)
        )
        ttk.Label(
            wrap,
            text="Exports a combined app.ico (all sizes) AND/OR separate app_16.ico, app_32.ico, ...",
            foreground="#5C6773",
        ).grid(row=1, column=0, columnspan=3, sticky="w", pady=(0, 12))

        # Input PNG
        ttk.Label(wrap, text="Input PNG:").grid(row=2, column=0, sticky="w", pady=4)
        ttk.Entry(wrap, textvariable=self.png_path).grid(row=2, column=1, sticky="ew", padx=8, pady=4)
        ttk.Button(wrap, text="Browse…", command=self._browse_png).grid(row=2, column=2, sticky="e", pady=4)

        # Output folder
        ttk.Label(wrap, text="Output folder:").grid(row=3, column=0, sticky="w", pady=4)
        ttk.Entry(wrap, textvariable=self.out_dir).grid(row=3, column=1, sticky="ew", padx=8, pady=4)
        ttk.Button(wrap, text="Choose…", command=self._browse_out_dir).grid(row=3, column=2, sticky="e", pady=4)

        # Base name
        ttk.Label(wrap, text="Base name:").grid(row=4, column=0, sticky="w", pady=4)
        ttk.Entry(wrap, textvariable=self.base_name, width=18).grid(row=4, column=1, sticky="w", padx=8, pady=4)

        # Mode
        mode_frame = ttk.LabelFrame(wrap, text="Square handling", padding=(10, 8))
        mode_frame.grid(row=5, column=0, columnspan=3, sticky="ew", pady=(10, 8))

        ttk.Radiobutton(
            mode_frame, text="Pad to square (transparent) — best for logos",
            value="pad", variable=self.mode_var
        ).grid(row=0, column=0, sticky="w", pady=2)

        ttk.Radiobutton(
            mode_frame, text="Center crop to square — best for photos",
            value="crop", variable=self.mode_var
        ).grid(row=1, column=0, sticky="w", pady=2)

        ttk.Radiobutton(
            mode_frame, text="Stretch to square (may distort)",
            value="stretch", variable=self.mode_var
        ).grid(row=2, column=0, sticky="w", pady=2)

        # Output options
        out_frame = ttk.LabelFrame(wrap, text="Outputs", padding=(10, 8))
        out_frame.grid(row=6, column=0, columnspan=3, sticky="ew", pady=(8, 8))

        ttk.Checkbutton(
            out_frame, text="Create combined ICO (base_name.ico with all sizes inside)",
            variable=self.make_combined_var
        ).grid(row=0, column=0, sticky="w", pady=2)

        ttk.Checkbutton(
            out_frame, text="Create split ICOs (base_name_16.ico, base_name_32.ico, ...)",
            variable=self.make_split_var
        ).grid(row=1, column=0, sticky="w", pady=2)

        # Buttons
        btn_row = ttk.Frame(wrap)
        btn_row.grid(row=7, column=0, columnspan=3, sticky="ew", pady=(10, 0))
        ttk.Button(btn_row, text="Create icons", command=self._run).pack(side=tk.RIGHT)
        ttk.Button(btn_row, text="Quit", command=self.master.destroy).pack(side=tk.RIGHT, padx=(0, 8))

        wrap.columnconfigure(1, weight=1)

    def _browse_png(self):
        path = filedialog.askopenfilename(
            title="Select a PNG file",
            filetypes=[("PNG files", "*.png"), ("All files", "*.*")]
        )
        if not path:
            return
        self.png_path.set(path)

        # Auto-fill output folder to same folder as input
        folder = os.path.dirname(path)
        if folder and not self.out_dir.get().strip():
            self.out_dir.set(folder)

        # Auto base name from file if still default
        if self.base_name.get().strip() == "app":
            base = os.path.splitext(os.path.basename(path))[0]
            self.base_name.set(base)

    def _browse_out_dir(self):
        path = filedialog.askdirectory(title="Choose an output folder")
        if not path:
            return
        self.out_dir.set(path)

    def _run(self):
        png = self.png_path.get().strip()
        out_dir = self.out_dir.get().strip()
        base_name = self.base_name.get().strip() or "app"
        mode = self.mode_var.get().strip()

        if not png or not os.path.isfile(png):
            messagebox.showerror("Missing input", "Please choose a valid input PNG.")
            return
        if not out_dir:
            messagebox.showerror("Missing output folder", "Please choose an output folder.")
            return

        if not (self.make_combined_var.get() or self.make_split_var.get()):
            messagebox.showwarning("No outputs selected", "Select at least one output option.")
            return

        try:
            img = Image.open(png)
            base = _prepare_base(img, mode)

            created = []

            if self.make_combined_var.get():
                combined_path = os.path.join(out_dir, f"{base_name}.ico")
                export_multi_ico(base, combined_path)
                created.append(os.path.basename(combined_path))

            if self.make_split_var.get():
                export_split_icos(base, out_dir, base_name)
                created.extend([f"{base_name}_{s}.ico" for s in SIZES])

        except Exception as e:
            messagebox.showerror("Failed", f"Could not create icons:\n\n{e}")
            return

        messagebox.showinfo(
            "Success",
            "Created:\n\n" + "\n".join(created)
        )


def main():
    root = tk.Tk()
    app = IconMakerApp(root)
    app.pack(fill=tk.BOTH, expand=True)
    root.mainloop()


if __name__ == "__main__":
    main()